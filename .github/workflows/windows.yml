name: FREE‚ÄëRDP‚ÄëWINDOWS‚Äë2022‚ÄëNGROK

on:
  workflow_dispatch  # Manual trigger

jobs:
  rdp:
    runs-on: windows-2022
    timeout-minutes: 360

    steps:
    #---------------------------------------------
    # 1. Download Ngrok (v3+) and keep-alive script
    #---------------------------------------------
    - name: ‚¨áÔ∏è Download Ngrok and keep-alive
      run: |
        Invoke-WebRequest `
          -Uri https://bin.ngrok.com/ngrok-v3-stable-windows-amd64.zip `
          -OutFile $Env:RUNNER_TEMP\ngrok.zip
        Expand-Archive $Env:RUNNER_TEMP\ngrok.zip -DestinationPath $Env:RUNNER_TEMP
        Set-Content -Path $Env:RUNNER_TEMP\keep.ps1 -Value 'while ($true) { Start-Sleep 300 }'

    #---------------------------------------------
    # 2. Add ngrok config file with authtoken
    #---------------------------------------------
    - name: üîê Configure Ngrok (authtoken + tunnel)
      env:
        NG_TOK: ${{ secrets.NGROK_TOKEN }}
      run: |
        $config = @"
authtoken: $Env:NG_TOK
region: ap
tunnels:
  rdp:
    proto: tcp
    addr: 3389
"@
        $config | Out-File -Encoding ASCII "$Env:USERPROFILE\.ngrok2\ngrok.yml"

    #---------------------------------------------
    # 3. Enable Remote Desktop & open firewall
    #---------------------------------------------
    - name: üîß Enable RDP + Firewall
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user runneradmin "P@ssw0rd!2025"
        Write-Host "‚úîÔ∏è  RDP Enabled ‚Äî Username: runneradmin | Password: P@ssw0rd!2025"

    #---------------------------------------------
    # 4. Start Ngrok with config (v3 syntax)
    #---------------------------------------------
    - name: üöá Start Ngrok tunnel
      run: |
        Start-Process -FilePath "$Env:RUNNER_TEMP\ngrok.exe" `
                      -ArgumentList "start", "--all", "--config", "$Env:USERPROFILE\.ngrok2\ngrok.yml" `
                      -WindowStyle Hidden
        Start-Sleep -Seconds 10

    #---------------------------------------------
    # 5. Fetch Ngrok tunnel public address
    #---------------------------------------------
    - name: üåê Fetch RDP Public Address
      id: tunnel
      run: |
        $url = (Invoke-RestMethod -Uri http://127.0.0.1:4040/api/tunnels).tunnels[0].public_url
        echo "::set-output name=url::$url"
        Write-Host "========================================"
        Write-Host "‚ñ∂Ô∏è  CONNECT TO RDP USING THESE DETAILS:"
        Write-Host "üîó  $url"
        Write-Host "üë§  User: runneradmin"
        Write-Host "üîë  Pass: P@ssw0rd!2025"
        Write-Host "========================================"

    #---------------------------------------------
    # 6. Keep the GitHub Runner alive (up to 6 hrs)
    #---------------------------------------------
    - name: ‚è≥ Keep session alive
      shell: pwsh
      run: |
        & $Env:RUNNER_TEMP\keep.ps1
