name: FREE‚ÄëRDP‚ÄëWINDOWS‚Äë2022‚ÄëNGROK
on:
  workflow_dispatch

jobs:
  rdp:
    runs-on: windows-2022
    timeout-minutes: 360
    steps:

    #---------------------------------------------
    # 1. Download ngrok binary and keep-alive script
    #---------------------------------------------
    - name: ‚¨áÔ∏è  Download ngrok & keep‚Äëalive script
      run: |
        Invoke-WebRequest `
          -Uri https://bin.ngrok.com/ngrok-v3-stable-windows-amd64.zip `
          -OutFile $Env:RUNNER_TEMP\ngrok.zip
        Expand-Archive $Env:RUNNER_TEMP\ngrok.zip -DestinationPath $Env:RUNNER_TEMP
        Set-Content -Path $Env:RUNNER_TEMP\keep.ps1 -Value 'while ($true) { Start-Sleep 300 }'

    #---------------------------------------------
    # 2. Authenticate ngrok (v3 syntax)
    #---------------------------------------------
    - name: üîê ngrok authtoken
      env:
        NG_TOK: ${{ secrets.NGROK_TOKEN }}
      run: |
        & "$Env:RUNNER_TEMP\ngrok.exe" config add-authtoken $Env:NG_TOK

    #---------------------------------------------
    # 3. Enable Remote Desktop & open firewall
    #---------------------------------------------
    - name: üîß Enable RDP + firewall
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user runneradmin "P@ssw0rd!2025"
        Write-Host "‚úîÔ∏è  RDP enabled. Username:
