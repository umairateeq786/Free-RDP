name: FREE-RDP-WINDOWS-2022-NGROK

on:
  workflow_dispatch

jobs:
  rdp:
    runs-on: windows-2022
    timeout-minutes: 360

    steps:

    # Step 1: Download ngrok and keep-alive script
    - name: â¬‡ï¸ Download ngrok & keep-alive script
      run: |
        Invoke-WebRequest `
          -Uri https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip `
          -OutFile $Env:RUNNER_TEMP\ngrok.zip
        Expand-Archive -Path $Env:RUNNER_TEMP\ngrok.zip -DestinationPath $Env:RUNNER_TEMP
        Set-Content -Path $Env:RUNNER_TEMP\keep.ps1 -Value 'while ($true) { Start-Sleep 300 }'

    # Step 2: Set ngrok authtoken (v3 syntax)
    - name: ğŸ” Authenticate ngrok
      env:
        NG_TOK: ${{ secrets.NGROK_TOKEN }}  # Add this token in GitHub: Settings > Secrets > Actions
      run: |
        & "$Env:RUNNER_TEMP\ngrok.exe" config add-authtoken $Env:NG_TOK

    # Step 3: Enable Remote Desktop and open firewall
    - name: ğŸ”§ Enable RDP + firewall
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user runneradmin "P@ssw0rd!2025"
        Write-Host "âœ”ï¸ RDP enabled. Username: runneradmin | Password: P@ssw0rd!2025"

    # Step 4: Start ngrok TCP tunnel on port 3389 (RDP)
    - name: ğŸš‡ Start ngrok tunnel (TCP 3389)
      run: |
        Start-Process -FilePath "$Env:RUNNER_TEMP\ngrok.exe" `
                      -ArgumentList "tcp 3389 --region ap --log stdout" `
                      -WindowStyle Hidden
        Start-Sleep -Seconds 10

    # Step 5: Fetch public ngrok address
    - name: ğŸŒ Fetch public RDP address
      id: get_addr
      run: |
        $tunnel = (Invoke-RestMethod -Uri http://127.0.0.1:4040/api/tunnels).tunnels[0].public_url
        echo "::set-output name=url::$tunnel"
        Write-Host "======================================"
        Write-Host "â–¶ï¸ CONNECT TO RDP:"
        Write-Host "ğŸ”— Address: $tunnel"
        Write-Host "ğŸ‘¤ User: runneradmin"
        Write-Host "ğŸ”‘ Pass: P@ssw0rd!2025"
        Write-Host "======================================"

    # Step 6: Keep session alive
    - name: â³ Keep session alive
      shell: pwsh
      run: |
        & $Env:RUNNER_TEMP\keep.ps1
